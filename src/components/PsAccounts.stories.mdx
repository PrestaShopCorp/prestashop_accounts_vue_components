import { Meta, Story, Preview, Props, Description } from '@storybook/addon-docs/blocks';
import { withKnobs, object } from '@storybook/addon-knobs';

import PsAccounts from './PsAccounts';

<Meta title="Integration|PsAccounts panel" component={PsAccounts} decorators={[withKnobs]} />

# PsAccounts component purposes

`PsAccounts` component is the only one you need to instantiate if you have standard needs.
This component will take a context object (that is injected in javascript through your module,
[in the PHP part, with a specific presenter](http://perdu.com)) and **all cases will be managed
for you (error cases, insufficient prerequisites, button to link user account, etc...)**.


## Prerequisites to integrate the component

- Your module must have **a settings page**, to display in the PrestaShop backoffice, in the
Modules / Module manager part, when the user clicks on the 'Configure' button.
- This **page must use VueJS** (to let `PsAccounts` being integrated in a correct way).
- Your **settings should be unavailable as long as the user is not linked** to PrestaShop account yet
(the **`PsAccounts` component will manage this condition** for you through its slots).
- Before to add `PsAccounts` to your settings page, you need to **inject the presenter given by
[prestashop_accounts_auth library](http://perdu.com) in the PHP code** of your module.

---
## Component behaviors

Once integrated, the component can show different cases:


### The user is not connected yet

<Story name='Not connected' height='230px'>
  {{
    components: { PsAccounts },
    props: {
      context: {
        default: object('context', {
          psAccountsIsInstalled: true,
          psAccountIsEnabled: true,
          currentShop: {
            id: 1,
            name: 'PrestaShop',
            url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
            domain: 'my-domain.com',
            domainSsl: 'my-secure-domain.com',
          },
          shops: [
            {
              id: 1,
              name: 'Default',
              shops: [
                {
                  id: 1,
                  name: 'PrestaShop',
                  url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
                  domain: 'my-domain.com',
                  domainSsl: 'my-secure-domain.com',
                }
              ],
            },
          ],
          user: {
            email: null,
            emailIsValidated: false,
            isAdmin: true,
          },
          onboardingLink: 'http://perdu.com'
        })
      },
    },
    template: '<PsAccounts :context="context" class="m-4">' +
      '<template v-slot:body>- Module settings part, disabled -</template>' +
    '</PsAccounts>',
  }}
</Story>

_You can see that the settings part given in the `v-slot:body` is disabled (covered
by a translucent shield to avoid any interaction on it)._


### The user may choose a shop first

If the shop is in a multi-store context, the user will have a selector like this:

<Story name='Multistore selection' height='310px'>
  {{
    components: { PsAccounts },
    props: {
      context: {
        default: object('context', {
          psAccountsIsInstalled: true,
          psAccountIsEnabled: true,
          currentShop: null,
          shops: [
            {
              id: 1,
              name: 'Default',
              shops: [
                {
                  id: 1,
                  name: 'PrestaShop',
                  url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
                  domain: 'my-domain.com',
                  domainSsl: 'my-secure-domain.com',
                }
              ],
            },
          ],
          user: {
            email: null,
            emailIsValidated: false,
            isAdmin: true,
          },
          onboardingLink: 'http://perdu.com'
        })
      },
    },
    template: '<PsAccounts :context="context" class="m-4">' +
      '<template v-slot:body>- Module settings part, disabled -</template>' +
    '</PsAccounts>',
  }}
</Story>


### The user is connected, but his email is not yet validated

<Story name='Email validation needed' height='400px'>
  {{
    components: { PsAccounts },
    props: {
      context: {
        default: object('context', {
          psAccountsIsInstalled: true,
          psAccountIsEnabled: true,
          currentShop: {
            id: 1,
            name: 'PrestaShop',
            url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
            domain: 'my-domain.com',
            domainSsl: 'my-secure-domain.com',
          },
          shops: [
            {
              id: 1,
              name: 'Default',
              shops: [
                {
                  id: 1,
                  name: 'PrestaShop',
                  url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
                  domain: 'my-domain.com',
                  domainSsl: 'my-secure-domain.com',
                },
                {
                  id: 2,
                  name: 'shop2',
                  url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-2&token=7e6ed965a445faaa639275d16418264d',
                  domain: 'my-domain2.com',
                  domainSsl: 'my-secure-domain2.com',
                },
              ],
            },
          ],
          user: {
            email: 'merchant@my-shop.com',
            emailIsValidated: false,
            isAdmin: true,
          },
          onboardingLink: 'http://perdu.com'
        })
      },
    },
    template: '<PsAccounts :context="context" class="m-4">' +
      '<template v-slot:body>- I am connected, but the email is not validated -</template>' +
    '</PsAccounts>',
  }}
</Story>

In this case, the user cannot continue his settings process. He have to validate
his address from the link received in his mailbox.


### The user is connected

<Story name='Connected' height='230px'>
  {{
    components: { PsAccounts },
    props: {
      context: {
        default: object('context', {
          psAccountsIsInstalled: true,
          psAccountIsEnabled: true,
          currentShop: {
            id: 1,
            name: 'PrestaShop',
            url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
            domain: 'my-domain.com',
            domainSsl: 'my-secure-domain.com',
          },
          shops: [
            {
              id: 1,
              name: 'Default',
              shops: [
                {
                  id: 1,
                  name: 'PrestaShop',
                  url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
                  domain: 'my-domain.com',
                  domainSsl: 'my-secure-domain.com',
                },
                {
                  id: 2,
                  name: 'shop2',
                  url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-2&token=7e6ed965a445faaa639275d16418264d',
                  domain: 'my-domain2.com',
                  domainSsl: 'my-secure-domain2.com',
                },
              ],
            },
          ],
          user: {
            email: 'merchant@my-shop.com',
            emailIsValidated: true,
            isAdmin: true,
          },
          onboardingLink: 'http://perdu.com'
        })
      },
    },
    template: '<PsAccounts :context="context" class="m-4">' +
      '<template v-slot:body>- I am connected -</template>' +
    '</PsAccounts>',
  }}
</Story>


---
## Missing prerequisites cases

You can have these different cases when the shop prerequisites are not fully validated:

<Story name='Not installed' height='230px'>
  {{
    components: { PsAccounts },
    props: {
      context: {
        default: object('context', {
          psAccountsIsInstalled: false,
          psAccountIsEnabled: true,
          currentShop: {
            id: 1,
            name: 'PrestaShop',
            url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
            domain: 'my-domain.com',
            domainSsl: 'my-secure-domain.com',
          },
          shops: [
            {
              id: 1,
              name: 'Default',
              shops: [
                {
                  id: 1,
                  name: 'PrestaShop',
                  url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
                  domain: 'my-domain.com',
                  domainSsl: 'my-secure-domain.com',
                },
                {
                  id: 2,
                  name: 'shop2',
                  url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-2&token=7e6ed965a445faaa639275d16418264d',
                  domain: 'my-domain2.com',
                  domainSsl: 'my-secure-domain2.com',
                },
              ],
            },
          ],
          user: {
            email: 'merchant@my-shop.com',
            emailIsValidated: true,
            isAdmin: true,
          },
          onboardingLink: 'http://perdu.com'
        })
      },
    },
    template: '<PsAccounts :context="context" class="m-4">' +
      '<template v-slot:body>- Module settings part, disabled -</template>' +
    '</PsAccounts>',
  }}
</Story>

<Story name='Not enabled' height='230px'>
  {{
    components: { PsAccounts },
    props: {
      context: {
        default: object('context', {
          psAccountsIsInstalled: true,
          psAccountIsEnabled: false,
          currentShop: {
            id: 1,
            name: 'PrestaShop',
            url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
            domain: 'my-domain.com',
            domainSsl: 'my-secure-domain.com',
          },
          shops: [
            {
              id: 1,
              name: 'Default',
              shops: [
                {
                  id: 1,
                  name: 'PrestaShop',
                  url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
                  domain: 'my-domain.com',
                  domainSsl: 'my-secure-domain.com',
                },
                {
                  id: 2,
                  name: 'shop2',
                  url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-2&token=7e6ed965a445faaa639275d16418264d',
                  domain: 'my-domain2.com',
                  domainSsl: 'my-secure-domain2.com',
                },
              ],
            },
          ],
          user: {
            email: 'merchant@my-shop.com',
            emailIsValidated: true,
            isAdmin: true,
          },
          onboardingLink: 'http://perdu.com'
        })
      },
    },
    template: '<PsAccounts :context="context" class="m-4">' +
      '<template v-slot:body>- Module settings part, disabled -</template>' +
    '</PsAccounts>',
  }}
</Story>

<Story name='No admin rights' height='340px'>
  {{
    components: { PsAccounts },
    props: {
      context: {
        default: object('context', {
          psAccountsIsInstalled: true,
          psAccountIsEnabled: true,
          currentShop: {
            id: 1,
            name: 'PrestaShop',
            url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
            domain: 'my-domain.com',
            domainSsl: 'my-secure-domain.com',
          },
          shops: [
            {
              id: 1,
              name: 'Default',
              shops: [
                {
                  id: 1,
                  name: 'PrestaShop',
                  url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
                  domain: 'my-domain.com',
                  domainSsl: 'my-secure-domain.com',
                },
                {
                  id: 2,
                  name: 'shop2',
                  url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-2&token=7e6ed965a445faaa639275d16418264d',
                  domain: 'my-domain2.com',
                  domainSsl: 'my-secure-domain2.com',
                },
              ],
            },
          ],
          user: {
            email: null,
            emailIsValidated: false,
            isAdmin: false,
          },
          onboardingLink: 'http://perdu.com'
        })
      },
    },
    template: '<PsAccounts :context="context" class="m-4">' +
      '<template v-slot:body>- Module settings part, disabled -</template>' +
    '</PsAccounts>',
  }}
</Story>


---
## Context invalidity cases

If the given context is not well formed, a validation error will be shown by the
component and the standard behavior won't let the user do anything:

<Story name='Invalid context' height='120px'>
  {{
    components: { PsAccounts },
    props: {
      context: {
        default: object('context', {
          psAccountsIsInstalled: 'true', // will pass: can be casted to boolean by Joi
          psAccountIsEnabled: 'ptet-ben-k-non',
          currentShop: 42,
          shops: [
            {
              id: 1,
              name: 'Default',
              shops: [
                {
                  id: 1,
                  name: 'PrestaShop',
                  url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
                  domain: 'my-domain.com',
                  domainSsl: 'my-secure-domain.com',
                }
              ],
            },
          ],
          user: {
            email: 'this-is-not-a-valid-email',
            emailIsValidated: 42,
            isAdmin: 0.07,
          },
          onboardingLink: '42*'
        })
      },
    },
    template: '<PsAccounts :context="context" class="m-4">' +
      '<template v-slot:body>- I am connected -</template>' +
      '<template v-slot:customBody>- Custom body, always present -</template>' +
    '</PsAccounts>',
  }}
</Story>

So you have to comply with the context object format or simply use the one
given by the PHP presenter of prestashop_accounts_auth library.


---
# Integration

Let's integrate the component itself:

```html
<PsAccounts :context="context" class="m-4">
  <template v-slot:body> <div>Slot shown when account is linked</div> </template>
  <template v-slot:customBody> <div>Custom body, always shown (for custom display condition)</div> </template>
</PsAccounts>
```

# Technical details

<Description of={PsAccounts} />
<Props of={PsAccounts} />
