import { Meta, Story, Preview, Props, Description } from '@storybook/addon-docs';
import { action } from '@storybook/addon-actions';

import PsAccounts from './PsAccounts.vue';

<Meta
  title="Integration/PsAccounts panel"
  component={PsAccounts}
  parameters={{
    disableScopedCssDecorator: true,
  }} />

export const Template = (args, { argTypes }) => ({
  props: Object.keys(argTypes),
  components: { PsAccounts },
  methods: {
    actionEvent: action('actioned'),
    viewEvent: action('viewed'),
  },
  template: `
    <PsAccounts v-bind="$props" @actioned="actionEvent" @viewed="viewEvent" class="m-4">
      <template v-slot:body>{{slotContent}}</template>
    </PsAccounts>
  `,
})

export const props = {
  context: {
    accountsUiUrl: "https://accounts.distribution.prestashop.net/en",
    adminAjaxLink: "http://localhost:8082/admin-dev/index.php?controller=AdminAjaxPsAccounts&ajax=1&token=0c02b2c71c53f0ec068a03572123cecc",
    psIs17: true,
    psAccountsInstallLink: null,
    psAccountsEnableLink: null,
    psAccountsIsInstalled: true,
    psAccountsIsEnabled: true,
    psAccountsIsUptodate: true,
    currentContext: {
      id: '1',
      type: '1',
    },
    currentShop: {
      id: '1',
      name: 'PrestaShop',
      url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
      domain: 'my-domain.com',
      domainSsl: 'my-secure-domain.com',
    },
    shops: [
      {
        id: '1',
        name: 'Default',
        shops: [
          {
            id: '1',
            name: 'PrestaShop',
            url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
            domain: 'my-domain.com',
            domainSsl: 'my-secure-domain.com',
            isLinkedV4: false,
          }
        ],
      },
    ],
    backendUser: {
      email: 'email@bo.com',
      isSuperAdmin: true,
      employeeId: 1,
    },
    user: {
      email: null,
      emailIsValidated: false,
      isSuperAdmin: true,
    },
    onboardingLink: 'http://perdu.com',
    superAdminEmail: 'big.boss@my-shop.com',
    ssoResendVerificationEmail: 'http://perdu.com',
    manageAccountLink: 'http://perdu.com',
    dependencies: {
        "ps_eventbus": {
          "enableLink": "http://localhost:80/admin-dev/index.php/improve/modules/manage/action/enable/ps_eventbus?_token=up_TmQFm66p9dwunsmfNzk2UfDD3a8tsxdW5a7KviKw",
          "installLink": "http://localhost:80/admin-dev/index.php/improve/modules/manage/action/install/ps_eventbus?_token=up_TmQFm66p9dwunsmfNzk2UfDD3a8tsxdW5a7KviKw",
          "isEnabled": true,
          "isInstalled": true,
        },
    },
  },
  slotContent: '- Module settings part, disabled -',
}

# PsAccounts component purposes

`PsAccounts` component is the only one you need to instantiate if you have standard needs.
This component will take a context object (that is injected in javascript through your module,
[in the PHP part, with a specific presenter](https://github.com/PrestaShopCorp/prestashop-accounts-installer)) and **all cases will be managed
for you (error cases, insufficient prerequisites, button to link user account, etc...)**.


## Prerequisites to integrate the component

- Your module must have **a settings page**, to display in the PrestaShop backoffice, in the
Modules / Module manager part, when the user clicks on the 'Configure' button.
- This **page must use VueJS** (to let `PsAccounts` being integrated in a correct way).
- Your **settings should be unavailable as long as the user is not linked** to PrestaShop account yet
(the **`PsAccounts` component will manage this condition** for you through its slots).
- Before to add `PsAccounts` to your settings page, you need to **inject the presenter given by
[prestashop-accounts-installer](https://github.com/PrestaShopCorp/prestashop-accounts-installer) in the PHP code** of your module.

---
## Component behaviors

Once integrated, the component can show different cases:


### The user is not connected yet

<Story
  name='Not connected'
  height='200px'
  args={{
      ...props,
  }}>
  {Template.bind({})}
</Story>

_You can see that the settings part given in the `v-slot:body` is disabled (covered
by a translucent shield to avoid any interaction on it)._


### The user is connected, but his email is not yet validated

<Story
  name='Email validation needed'
  height='200px'
  args={{
      ...props,
      context: {
        ...props.context,
        shops: [
          {
            id: '1',
            name: 'Default',
            shops: [
              {
                id: '1',
                name: 'PrestaShop',
                url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
                domain: 'my-domain.com',
                domainSsl: 'my-secure-domain.com',
                user: {
                  email: 'merchant@my-shop.com',
                  emailIsValidated: false,
                  isSuperAdmin: true,
                },
                employeeId: '1',
                isLinkedV4: false,
                uuid: 'abcde-fghij',
              },
              {
                id: '2',
                name: 'shop2',
                url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-2&token=7e6ed965a445faaa639275d16418264d',
                domain: 'my-domain2.com',
                domainSsl: 'my-secure-domain2.com',
                user: {
                  email: 'merchant@my-shop.com',
                  emailIsValidated: false,
                  isSuperAdmin: true,
                },
                employeeId: '1',
                isLinkedV4: false,
                uuid: 'abcde-fghij',
              },
            ],
          },
        ],
        backendUser: {
          email: 'admin@example.com',
          isSuperAdmin: true,
          employeeId: 1,
        },
        user: {
          email: 'merchant@my-shop.com',
          emailIsValidated: false,
          isSuperAdmin: true,
        },
      },
      slotContent: '- I am connected, but the email is not validated -',
    }}>
  {Template.bind({})}
</Story>

In this case, the user cannot continue his settings process. He have to validate
his address from the link received in his mailbox.


### The user is connected

<Story
  name='Connected'
  height='200px'
  args={{
      ...props,
      context: {
        ...props.context,
        shops: [
          {
            id: '1',
            name: 'Default',
            shops: [
              {
                id: '1',
                name: 'PrestaShop',
                url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
                domain: 'my-domain.com',
                domainSsl: 'my-secure-domain.com',
                user: {
                  email: 'merchant@my-shop.com',
                  emailIsValidated: true,
                  isSuperAdmin: true,
                },
                employeeId: '1',
                isLinkedV4: false,
                uuid: 'abcde-fghij',
              },
              {
                id: '2',
                name: 'shop2',
                url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-2&token=7e6ed965a445faaa639275d16418264d',
                domain: 'my-domain2.com',
                domainSsl: 'my-secure-domain2.com',
                user: {
                  email: 'merchant@my-shop.com',
                  emailIsValidated: true,
                  isSuperAdmin: true,
                },
                employeeId: '1',
                isLinkedV4: false,
                uuid: 'abcde-fghij',
              },
            ],
          },
        ],
        user: {
          email: 'merchant@my-shop.com',
          emailIsValidated: true,
          isSuperAdmin: true,
        },
        backendUser: {
          email: 'admin@example.com',
          isSuperAdmin: true,
          employeeId: 1,
        },
      },
      slotContent: '- Module configuration slot -',
    }}>
  {Template.bind({})}
</Story>

Once the merchant has successfully linked his shop, the module should give
access to the merchant to its configuration (onboarding panel under PrestaShop
Account panel, configuration tabs...). These features don't have to be
accessible until the merchant is done with PrestaShop account onboarding.


---
## Missing prerequisites cases

You can have these different cases when the shop prerequisites are not fully validated:

<Story
  name='Not installed'
  height='200px'
  args={{
      ...props,
      context: {
        ...props.context,
        psAccountsIsInstalled: false,
        shops: [
          {
            id: '1',
            name: 'Default',
            shops: [
              {
                id: '1',
                name: 'PrestaShop',
                url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
                domain: 'my-domain.com',
                domainSsl: 'my-secure-domain.com',
              },
              {
                id: '2',
                name: 'shop2',
                url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-2&token=7e6ed965a445faaa639275d16418264d',
                domain: 'my-domain2.com',
                domainSsl: 'my-secure-domain2.com',
              },
            ],
          },
        ],
        user: {
          email: 'merchant@my-shop.com',
          emailIsValidated: true,
          isSuperAdmin: true,
        },
        backendUser: {
          email: 'admin@example.com',
          isSuperAdmin: true,
          employeeId: 1,
        },
      },
    }}>
  {Template.bind({})}
</Story>

---

<Story
  name='Not enabled'
  height='200px'
  args={{
      ...props,
      context: {
        ...props.context,
        psAccountsIsEnabled: false,
        shops: [
          {
            id: '1',
            name: 'Default',
            shops: [
              {
                id: '1',
                name: 'PrestaShop',
                url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
                domain: 'my-domain.com',
                domainSsl: 'my-secure-domain.com',
              },
              {
                id: '2',
                name: 'shop2',
                url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-2&token=7e6ed965a445faaa639275d16418264d',
                domain: 'my-domain2.com',
                domainSsl: 'my-secure-domain2.com',
              },
            ],
          },
        ],
        user: {
          email: 'merchant@my-shop.com',
          emailIsValidated: true,
          isSuperAdmin: true,
        },
        backendUser: {
          email: 'admin@example.com',
          isSuperAdmin: true,
          employeeId: 1,
        },
      },
    }}>
  {Template.bind({})}
</Story>

---

<Story
  name='Ps event bus not installed'
  height='200px'
  args={{
      ...props,
      context: {
        ...props.context,
        dependencies: {
          ...(props.context ? props.context.dependencies : {}),
          ps_eventbus: {
            ...(props.context ? props.context.dependencies.ps_eventbus : {}),
            isEnabled: false,
            isInstalled: false,
          },
        },
      },
    }}>
  {Template.bind({})}
</Story>

---

<Story
  name='Ps Accounts needs an update'
  height='200px'
  args={{
      ...props,
      context: {
        ...props.context,
        psAccountsIsUptodate: false,
      },
    }}>
  {Template.bind({})}
</Story>

---

<Story
  name='No admin rights'
  height='200px'
  args={{
      ...props,
      context: {
        ...props.context,
        user: {
          email: null,
          emailIsValidated: false,
          isSuperAdmin: false,
        },
        backendUser: {
          email: 'admin@example.com',
          isSuperAdmin: false,
          employeeId: 1,
        },
      },
    }}>
  {Template.bind({})}
</Story>

## Context invalidity cases

If the given context is not well formed, a validation error will be shown by the
component and the standard behavior won't let the user do anything:

<Story
  name='Invalid context'
  height='200px'
  args={{
      ...props,
      context: {
        ...props.context,
        manageAccountLink: 42
      },
    }}>
  {Template.bind({})}
</Story>

So you have to comply with the context object format or simply use the one
given by the PHP presenter of ps_accounts module.


---
# Integration

Let's integrate the component itself:

In your own VueJS component:
```javascript
import {PsAccounts} from 'prestashop_accounts_vue_components';
export default {
  name: 'MyComponent',
  components: {
    PsAccounts,
    ...
  },
  ...
}
```

And in the template part:
```html
<PsAccounts :context="context">
  <template v-slot:body> <div>Slot shown when account is linked</div> </template>
  <template v-slot:account-footer><div>My other component in the footer of the account component</div></template>
  <template v-slot:customBody> <div>Custom body, always shown (for custom display condition)</div> </template>
</PsAccounts>
```

# Technical details

<Description of={PsAccounts} />
<Props of={PsAccounts} />


---
# Using the component footer slot

If you want to pass something to the component footer like another component you can by using the slot account-footer

export const FooterSlotTemplate = (args, {argTypes}) => ({
    props: Object.keys(argTypes),
    components: { PsAccounts },
    methods: {
      actionEvent: action('actioned'),
      viewEvent: action('viewed'),
    },
    template: '<PsAccounts :context="context" @actioned="actionEvent" @viewed="viewEvent" class="m-4">' +
      '<template v-slot:body>- Module configuration slot -</template>' +
      '<template v-slot:account-footer><div style="padding:0.5rem; background: gray; color: #fff;">My other component in the footer of the account component</div></template>'+
    '</PsAccounts>',
  })

<Story
  name='Using the component footer slot'
  args={{
    ...props,
    context: {
      ...props.context,
      shops: [
        {
          id: '1',
          name: 'Default',
          shops: [
            {
              id: '1',
              name: 'PrestaShop',
              url: 'http://localhost:8082/admin-dev/index.php?controller=AdminModules&setShopContext=s-1&token=7e6ed965a445faaa639275d16418264d',
              domain: 'my-domain.com',
              domainSsl: 'my-secure-domain.com',
              user: {
                email: 'merchant@my-shop.com',
                emailIsValidated: true,
                isSuperAdmin: true,
              },
              employeeId: '1',
              isLinkedV4: false,
              uuid: 'abcde-fghij',
            },
          ],
        },
      ],
    }
  }}
  height='200px'>
  {FooterSlotTemplate.bind({})}
</Story>
